<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VisionSafe | Alerts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    {% include "navbar.html" %}

    <div class="container mt-4">
        <h4>Active Safety Alerts</h4>
        <p class="text-muted">Real-time risk scoring (Frequency + Severity)</p>

        <div id="alertsContainer" class="mt-3">
            <div class="alert alert-info">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                Loading risk data...
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR API LINK
        const API_URL = "https://didactic-space-engine-7vj9rvw54979fx7jq-8000.app.github.dev";

        console.log("üöÄ Script Started");

        async function loadAlerts() {
            const container = document.getElementById("alertsContainer");
            
            try {
                // Fetch data
                const response = await fetch(`${API_URL}/recent`);
                if (!response.ok) throw new Error("Backend not connected");
                
                const logs = await response.json();
                container.innerHTML = ""; // Clear "Loading..."

                if (!logs || logs.length === 0) {
                    container.innerHTML = `<div class="alert alert-success">‚úÖ No violations found.</div>`;
                    return;
                }

                // --- THE LOGIC LOOP ---
                logs.slice(0, 20).forEach(log => {
                    // A. Get Data Safely
                    const strikes = parseInt(log.Strikes || log.violation_count || 1);
                    let rawPPE = log.missing_ppe || log.Violation || "Unknown";
                    
                    // B. Count Missing Items (The "Severity")
                    let missingCount = 1;
                    let displayPPE = rawPPE;

                    if (Array.isArray(rawPPE)) {
                        missingCount = rawPPE.length;
                        displayPPE = rawPPE.join(", ");
                    } else if (typeof rawPPE === 'string') {
                        displayPPE = rawPPE;
                        if (rawPPE.includes(',')) missingCount = rawPPE.split(',').length;
                    }

                    // C. üö® THE RISK FORMULA üö®
                    // Score = (Strikes x 10) + (Missing Items x 30)
                    const riskScore = (strikes * 10) + (missingCount * 30);

                    // D. Pick Color
                    let color = "alert-warning"; // Yellow
                    let label = "MEDIUM RISK";
                    let icon = "‚ö†Ô∏è";

                    if (riskScore >= 100) {
                        color = "alert-danger"; // Red
                        label = "CRITICAL RISK";
                        icon = "üö®";
                    } else if (riskScore < 50) {
                        color = "alert-secondary"; // Gray
                        label = "LOW RISK";
                        icon = "‚ÑπÔ∏è";
                    }

                    // E. Draw Box
                    container.innerHTML += `
                        <div class="alert ${color} d-flex justify-content-between align-items-center shadow-sm">
                            <div>
                                <strong>${icon} ${label} (Score: ${riskScore})</strong><br>
                                <span>Person <strong>${log.person_id || log.ID || "?"}</strong></span><br>
                                <span class="fw-bold">Missing: ${displayPPE}</span><br>
                                <small class="text-muted">${log.timestamp || log.Time}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-dark mb-1">Violation #${strikes}</span><br>
                                <span class="badge bg-light text-dark border">${missingCount} Items</span>
                            </div>
                        </div>
                    `;
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${err.message}</div>`;
            }
        }

        // Run immediately
        loadAlerts();
    </script>
</body>
</html>